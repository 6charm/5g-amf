To make a claim about the completeness of the Pyramis language and its feasibility as a replacement to 3GPP specifications, reason about its effectiveness at a per-3GPP-procedure granularity. Start with the UE Registration procedure. Below is the big question:
#--
# CAN PYRAMIS IN ITS CURRENT STATE BE USED TO COMMUNICATE EVERY REQUIREMENT OF UE REGISTRATION PROCEDURE AS SPECIFIED BY 3GPP to a programmer? 
#--


* Conclusions/Suggestions
==========================
dont know yet. 
Be more explicit about VNF domain-specific actions

1. Can we specify a multitier system in terms of the set of procedures it supports? (which are themselves reliant on the node configuration) by specifying the message-flows?

# 2. Alternative Pyramis primitives (getIE, setIE, shiftstate, createContext, updateContext) to allow for more diverse but still correct implementations.
There's an approx one-one correspondence between processing-file and the working testbed implementation i.e. the Pyramis processing file isnt a true specification of a VNF interface. 
- More general ideas that a spec should communicate: maintaining a node FSM, retrivieving message IEs, updating a context are specified by the 3GPP.
compared to eg: STORE/LOOKUP semantics refer to maps specifically specifying a FSM state update is more general than specifying a map update.


* Supplementary Information, 3GPP
=================================
2 categories of 5G networks: Public Networks and Non-Public Networks (NPN).
- Owned by the oranisation, offered by PLMNs a service. Communication, data is private to the organisation.
- SNPN (Standalone NPN): Does not use PLMN NFs. ---> PNI-NPN: private slice in PLMN network

NAS Messages and Signalling
- NAS is a protocol used in UE-5GS signalling.
- More precisely, UE <-> AMF via NAS at N1, RAN <-> AMF via N2, AMF <-> SMF via N11 interface. 
- TEST_RAN assumes the role of UE, communicates with AMF via building and encoding NAS messages
with UE request parameters.
- All control plane signalling messages are of type 5GMM


NAS Security


3GPP Timers


Registration "types"
@23502
3GPP defines a general registration procedure that is invoked in certain scenarios:
a. Initial registration with 5GS
b. Registration update -> if UE wants to change protocol parameters/capability in same TA. OR when UE TA moves outside of the saved TA in AMF.
c. Periodic registration (UE initiated)0 -> as a keepalive.


UE Capability
@38.306
A set of parameters stored in UE that describe its "capabilities". Mainly physical layer attributes/limitations. 
These include bandwidth information, Bandwidth(for single carrier) and Bandwidth Combination(for Carrier Aggregation), 
MIMO, Subcarrier Spacing etc. 
- The UE informs 5gs about its capabilities during registration.



The outcomes of initial registration:
- 5GS generates a 5G-GUTI for the UE that initiated the registration (AMF->UE via Registration Accept)
- 5GS generates a "network-identity" for the UE, stored as part of UE network context, i.e. amfuengapid at the AMF?

UE contexts
- Security context contains the UE specified NAS algorithms to be used to encrypt/decrypt keys during the authentication procedure with the amf. 

* Supplementary Information, synerg 5GS
=========================================
Contexts stored at the AMF
- AMF is initialised with information about the RAN(s) it expects to messages from via ranProfile_t instance for each RAN.
-  implemented using various maps for convenience, initialised on receipt of first NGAP message, updated at various points in the procedure call flow.
(The master map is UEMap that contains all UE-related info). 
- Context parameters are set by the UE that sent the initiating reg request as IEs.
(Does 3GPP specify context fields?)


--------------------------------------------------------------------------------
## A. Can Pyramis be used to specify node behaviour for all "registration types"?
--------------------------------------------------------------------------------
synerg TEST_RAN only triggers an Initial Registration Procedure during Load Test.

a. Initial Registration (acc. to synerg 5GC)
---------------------------------------------
1. TEST_RAN triggers a registration procedure via command-line which defaults to an Initial Registration Procedure, via
ran.cpp: 1535: testsendregistrationrequest(): `regReqMsg->_5gregType.value = initialRegistration;`
- The regreqmessage is contained in a NAS_PDU_t message, enclosed in an NGAP_PDU_t message.
- NAS message contains UE info, set by TEST_RAN independently.
- UE identity IE is generated by TEST_RAN as a SUCI by default and not 5G_GUTI.

2. synerg AMF has code for <mobility registration> and <periodic registration update>, but TEST_RAN does not send these regtypes during load test.

3. The AMF receives an NGAP_PDU_t message as the initial UE message. This contains a NAS_PDU_t message.
- handleinitialUEMessage() has the ability to:
a. Reliably access IEs (including RAN i.e AN identity info such as tracking area) from an NGAP message.
b. Reliably access a NAS message and from a given NGAP message and access its IEs.
c. (Enforce a timing contraint on retries by the same UE.)

4. handleinitialregistration() at AMF has the ability to:
a. Read the IEs of the NAS incoming message (such as UE identity).
b. Generate a unique "context" for each UE using information read from the IEs. (implementation defined)

*** Security Stuff ***	
AMF performs cursory security IE checks only. It passes authresponse to the AUSF to perform the actual challenge-response validation
5. with a UE context (inc. security) set, the AMF begins the UE authentication stage.
a. Sends a discovery message to NRF/checks cache to obtain AUSF IP. (as per the registration callflow) 
- perhaps user could specify the intended procedure CALL-FLOW (to autogenerate the discovery message)
b. sends an nausf_ueathreq. AUSF creates a UEauthcontext and sends it back to amf as a response. AMF validates the response.
c. AMF sends an authrequest to RAN via a NAS message, starts a timer T3560 (to constrain authresponse calculation time)

6. TEST_RAN receives the NGAP message containing the AuthReq from AMF.
- testRecvauthreq() can do:
a. validate the message it recd (confirm that the msgtype field is AUTHENTICATION_REQUEST). This is the UE challenge created by the AUSF
b. Update UE security context ngKSI at TEST_RAN, store the challenge in testUE.
c. Generate a response to the challenge at the UE, send authresponse to AMF.

7. AMF invokes a new handler handleuplinknastransport based on the procedurecodeIE of the message received.
- The authresponse needs to be handled.
a. ULNasTransport once again extracts UE location IEs and updates the AMFs UE context.
b. Stops a timer that was triggered earlier, indicates authresp received.
c. cursory validation of the authresponse IEs, nausf_ueauth_authen() forwards the response to ausf for validation.
d. On response from AUSF, update UE securitycontext on amf, trigger securitymodecommand

8. triggersecuritymodecommand() uses the newly-updated UE security context to send a securitymodecommand message to RAN (msgtype = SECURITY_MODE_COMMAND)
a. Compute NAS security keys (nas_integrity and nas_encryption) given UE-specified NAS algorithms.
b. Encode the message and send it to the TEST_RAN

9. TEST_RAN receives the NGAP_PDU_t message that contains the securitymodecommand_t message.
- Note that the smc_t is a standard asn type.
a. RAN (UE) ensures that all auth parameters calculated by network match the values calculated on the UE locally.
b. Send a securitymodecomplete message to AMF

10. AMF receives the securitymodecomplete message, handlesecmodecomplete()
a. The AMF updates its UE context with the latest UE location info as usual.
c. Update FSM state to E_UE_NAS_SECURITY_COMPLETE
b. Stops timer
c. trigger nudm_uecm()

11. nudm_uecm():
- Its purpose is to register a UE's serving NF with the UDM (now that the authenticated UE context is created at the amf, that particular amf can be safely treated as the serving amf to that particular UE). This information needs to be stored in the UDR (which has UDM as its interface)

12. AMF is storing the entire UE context into an InitialContextsetuprequest message, send this to Test_RAN signalling Registration on AMF is successful.
a. initialcontextsetuprequest() creates a request to be sent to AMF, with the allowed slices it can access (allowedNSSAIList i.e. list of nssai)
b. Sets the AMF FSM to CM_CONNECTED, stops the implicit-dereg timer, resets procedure code as the AMF isnt involved in any procedure anymore.

13. TEST_RAN receives the final UE context from AMF via testrecvregaccept(), updates the local UE context, sends an initialcontextsetupresponse() to amf.
- TEST_RAN by default sets it to always successful. is it an indication of whether the ue accepted the amf provided configurations?

14. handleinitialcontextsetupresponse() at AMF
a. performs the basic sanity checks to ensure message being processed is from the ran id associated with the current ue.
b. handles a successfuloutcome() and unsuccessfuloutcome() separately
- Just prints out a log for both success and failures.


a. Initial registration (acc. to Pyramis translated code)
----------------------------------------------------------
0. ngapIncoming() <-> initn1n2fsm() 

1. handleInitUE() + initialregistrationrequest() 
			<-> 
[handleinituecontext()] ->handleinitialregistration()

2. AUSFSelection() + ueAuthentication + ueauthenticationresponse() + nasauthentication()
		<->
nausf_ueauthentication() -> triggerAuthenticationRequest()

3. handleUPLN() + Nasauthenticationresponse() + ueAuthenticationUpdate() +
sbiIncoming()+ueauthenticationupdateresponse() + nassecuritymodecommand()
		<->
handleuplinknastransport()->handleauthenticationresponse() ->
Nausf_UEAuthentication_Authenticate() -> triggerSecurityModeCommand()

4. handleUPLN() + NasSecurityInitiationResponse() + initialcontextsetup() +

		<->
	handleuplinknastransport() -> handlesecmodecomplete() -> [nudm_uecm()] -> triggerinitialcontextsetuprequest()
- kinda odd. the nudm_uecm stuff is done after sending the initalcontextsetuprequest to ran and not before.

5. ngapIncoming() + initialcontextsetupresponse() + udmselection() + 
uecmregistration() + sbiincoming() + uecmregistrationresponse() + udmsdmget() + 
udmsdmgetresponse()
		<->
nudm_uecm()

6. registrationaccept() + registrationacceptresponse()
		<->
	handleinitialcontextsetupresponse() -> handleInitialContextSetupResponseSuccessfulOutcome()


Registration general occurences (non call-flow)
-----------------------------------------------
@23502
- 5gs stores the UE Physical identity (IMEI) in the UDM, subsequently udm->udr via nudr_sdm_update
- UE state can be CM-IDLE or CM-CONN. CM represents the state of a ue-amf signalling connection. amf has latest ue state as a result of registration. in combination with reg state, amf can trigger 

a. Initial Registration (acc. to 3GPP)
---------------------------------------
*** Setup stuff ***
UE sends a Registration Request message to RAN after setting a "Registration Type" (rt) I.E.
The registration type IE is then used by the 5GS to drive its actions.
1. (UE->RAN) : establish an RRC connection.
A set of params, defined below:
- UE sets rt to initial registration if UEState = RM-DEREGISTERED, rt to mobility registration update if UEState=rm-dereg etc.
- UE includes an identifier according to some rules, either a 5G-guti or a suci, plmnid, requested nssai i.e. slices, establishment cause. (Acess netwwork parasms) @33501 for suci)
- mobility registration update is triggered by network via a ue configuration update command. if AMF detects ue is not in the original registration area anymore.
- snssai: a slice representation. reg request include the mapping of UE slices with plmn subscriber slices
to allow 5gs to verify if UE slices can be setup for this subscriber.
- mobility reg needs to handle ongoing pdu sessiosn also, so req sends that list. (24501)
- security params used for authentication (33501)

2. (AMF selection at RAN)
- Optional. GUTI contains serving AMF details (UE has guti identifier means it has completed a reg before and hence does have a serving amf already). If no guti, RAN chooses an amf based on the requested nssai from UE.
- UE in cm-connected means theres is a nas connection setup between ue and amf via ran(n2)

3. (RAN->AMF)
- Forward the reg request with the interface parameters (same as the AN params)

4. (assuming no AMF change), (AMF->UE)
- Optional. sends an identityrequest if UE had not provided suci in the original message.
- UE generates a suci and sends the identiy response in that case.

5. (AUSF selection)
- SUCI is a subscriber identifier, with some default nf locations associated with it. 
- AUSf selected to begin auth procedure of a UE. 

6. (amf->ausf)
- amf initiates UE auth procedure. This auth checks if the ue trying to access the network with the 
suci of a particular subscriber is as expected. 
- method of auth is in 33501

7. NAS security initiation? (33501)

8. 

Defining a Multi-tier system:
1. Architecture
- Set of nodes (defined in terms of their interfaces and communication protocols)
2. Supported Procedures
- Procedure Names
- Mapping of procedure to a walk on the nodes of the mt graph


Review of Registration Callflow (what's being specified)?
Broadly, 23502 4.2.2 provides (for a procedure)
- An order in which nodes must be accessed.
- asn message-types that are sent/received
- 







2. UE sets its identity in the initial registration message (network-provided 5G-GUTI if available, SUCI if GUTI unavailable).
From https://www.tech-invite.com/3m23/toc/tinv-3gpp-23-502_a.html#e-4
A UE-provided PEI (Permanent equipment Identifier) will be sent in the initial registration message. 
However
From https://www.tech-invite.com/3m23/toc/tinv-3gpp-23-502_b.html#top
The spec retains the possibility of a UE with 5G GUTI performing another initial registration procedure.
- This seems to be conflicting. A registration update seems to be the appropriate procedure here.
3. 


---------------------------------------------------------------------------------------------------------------
## B. What sections of the implementation directly map to a 3GPP procedure specification and how much code/abstractions are artifacts of the implementation?
---------------------------------------------------------------------------------------------------------------
Cite 3GPP spec that corresponds to the implementation
eg: If 3GPP specifies the creation+updation of a UE context, a Pyramis keyword could be createContext+updateContext.

1. A common operation seems to be getting a value from a map. --> existence not specified by 3GPP, this is an implementation artifact, should not qualify for a Pyramis keyword.

2. Another common operation seems to be mainaining node FSMs. --> existence specified by 3GPP, this does qualify for a Pyramis keyword. 
- shiftstate(old, new)
- specifying a FSM state update is more general than specifying a map update

Q. How many errors are implementation defined and how many are 3GPP specified?






 
